<html>
<head>

    <meta charset="UTF-8">
    <!-- Load the d3 library. -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/d3.slider.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/styles.css" type="text/css">
    <link rel="stylesheet" href="css/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="css/d3.slider.css" type="text/css">
    
    <title>INFO 5100 Project 2 </title>
    <style>
        table {
            border:1px black;
        }
        svg {background: transparent;}
        .graticule {
            fill: none;
            stroke: #000;
            stroke-opacity: .3;
            stroke-width: .5px;
        }
        .boundary {
            fill: none;
            stroke: #000;
            stroke-width: .5px;
        }
        .dim {opacity: .25;}
        image {position:relative; float:left; clear:both;}
        .Hero, .Villain {fill:none;}
        .borderStroke {stroke:white; fill:none;}
        .Hero {stroke:white;}
        .Villain {stroke: black;}

        html {font-family: 'Oswald', sans-serif; font-weight:100; background: #f03138;}
        .wrapper {background: #f03138;}
        /*body {background-image: url(img/background-color.png); background-size: cover; background-position: fixed; padding:0; margin:0;}*/
        .header { height:350px; /*width:1280px; margin:50px;*/ margin-bottom:0px;border-bottom:1px dotted white;}
        .hidden {display:none;}
        #controls {/*width:250px;*/ position:relative; text-align:left; float:left; margin-left: 10px;}
        .heros {/*width: 800px;*/ /*position:relative;*/ float:left; /*margin-left:25px;*/}
        .row {/*width:1280px;*/ clear:both; display:block; color:green; min-height:100px;min-height:50px;}
        .row:before, .row:after {display:table; content: "";}
        h5 {color:white; font-weight:100; font-size:18px; margin-top:5px;}
        ul > li {color:white; font-weight:100; font-size:15px;}
        ul > li > input {position:relative; top:-2px;}
        #year {font-size:3em; width:100px; margin-top:25px; font-weight:400; border-right:1px dotted white; margin-right:15px; padding-right:15px;}
        #fact {font-size:1.75em; max-width:750px; margin-top:25px;}
        #year, #fact {color:white;
            position: relative;
            float: left;}
        td {padding:5px;}

    </style>
</head>
<body>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
</head>


<div class="wrapper container-fluid">
    <div class="header">
        <div style="position: relative; float:left; width:50%;">
            <img src="img/marvel-logo.png" style="width:75%; padding:50px;">
        </div>
        <div style="position: relative; float:left; width:40%; margin-top:30px; padding-right:25px;">
        <p style="color:white; font-size:20px; line-height:30px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dignissim ut massa nec pellentesque. Sed
    venenatis, mauris sed lacinia pellentesque, eros tellus scelerisque mauris, eget scelerisque velit urna in quam.
    Nulla facilisi. Aenean dignissim venenatis posuere. Nam lobortis augue in sem tristique lobortis. Duis rhoncus augue eget enim volutpat, at convallis est accumsan. Sed molestie urna felis, finibus egestas nisl porta eu. Nam vitae varius elit, eget ornare risus. Nulla placerat metus vitae mollis tristique.</p>
        </div>
    </div>

    <div class="">
        <div class="row" style="min-height:100px;/* margin-left:100px;*/ text-align:left !important;">
            <p style="width:900px; margin:0 auto;">
                <span id="year">1938</span>
                <span id="fact"></span>
            </p>
        </div>
        <div class="row" style="margin-top:25px; /*margin-left:100px; width:1280px;*/">
            <span style="color:white; height: 50px; margin-top: 10px; text-align: right;" class="col-xs-1">1938 &nbsp;</span>
            <span class="col-xs-10">
                <input id="slider" type="range" min="1938" max="2016" value="1938"/>
            </span>
            <span style="color:white; height: 50px; margin-top: 10px; " class="col-xs-1" >&nbsp;2016</span>
            <output></output>
            <div style="text-align:center;">
                <h3 style="color:white; letter-spacing: 2px; margin-bottom:0px; margin-top:0px;font-weight:100; font-style: italic; font-size:16px; padding-top:0px;" >
                        Slide to see some of the Marvel characters through the years</h3>
            </div>
            </div>
        <div class="row" style="border-bottom:1px dotted white; padding-bottom:25px;/*margin-left:100px;*/">
            <div id="controls" class=" col-xs-2">
            <br>
                <h5 style="margin-bottom:0px; padding:10px;">Sort characters:</h5>
                <select id="sortFilter" style="position:relative; left:10px;">
                    <option value="Name">Alphabetically</option>
                    <option value="originYear">Chronologically</option>
                    <option value="random">Random</option>
                </select>

                <h5 style="margin-bottom:0px; padding:10px;">Filter by Gender</h5>
                <ul style="list-style:none; margin-top:0px; margin-left:10px; padding-left:10px;padding-top:0px;">
                    <li>
                        <input type="checkbox" class="filter" checked="true" name="male" id="male" value="Male"></input>
                        <lablel for="male">Male</lablel>
                    </li>
                    <li>
                        <input type="checkbox" class="filter" checked="true" name="female" id="female" value="Female"></input>
                        <lablel for="female">Female</lablel>
                    </li>
                </ul>

                <h5 style="margin-bottom:0px; padding:10px;">Filter by Alignment</h5>
                <ul style="list-style:none; margin-top:0px; margin-left:10px; padding-left:10px;padding-top:0px;">
                    <li>
                        <input type="checkbox" class="filter" checked="true" name="Hero" id="Hero" value="Hero"></input>
                        <lablel for="Hero">Hero</lablel>
                    </li>
                    <li>
                        <input type="checkbox" class="filter" checked="true" name="Villain" id="Villain" value="Villain"></input>
                        <lablel for="Villain">Villain</lablel>
                    </li>

                </ul>
            </div>
            <div class="heros col-xs-8">
                <div id="heroPhotos"></div>
            </div>
        </div>

        <div class="row" style="text-align:center; background-color: black;">
            <h1 style="color:#0689bb; margin-top:25px; letter-spacing: 2px; margin-bottom:0px; /*margin-left:100px;*/margin-top:20px;font-weight:100; font-size:30px; padding-top:0px;">
                World Events and character's 'birthplace'
            </h1>

            <div id="map" style="display:inline; position:relative;"></div>
        
            <span style="color:white;height: 30px; margin-top: 10px; text-align: right;" class="col-xs-1">1938</span>
            <span class="col-xs-10">
            <input id="sliderMap" type="range" min="1938" max="2016" value="1938"/>
            </span>
            <span style="color:white;t: 30px; margin-top: 10px;text-align: left;" class="col-xs-1">2016</span>
        </div>
        <div style="background-color: black;" class="row ">
            <span style="color:#f03138;height: 30px; margin-top: 10px; text-align: right;" class="col-xs-1">Real World Events</span>
            <span id="eventtimeline" class="col-xs-10"></span>
        </div>
        <div style="text-align:center; background-color: black;" class="row">
            <h3 style="color:white; letter-spacing: 2px; margin-bottom:0px; margin-top:0px;font-weight:100; font-style: italic; font-size:16px; padding-top:0px;" >
                Slide through the time-line to see when a character was created and their 'birthplace'</h3>
        </div>

</div>

<script>
    var characters = {};
    var charaByYears = {};
    var characterInfo = {};
    var events = {};

    // Pulling data from the data.json file here.
    d3.json("json/data.json", function(error, data) {
        if (error) {
            console.log(error);
        }

        var filterYear = 1938;
        var charList = data;
        var width = 1200;

        var projection = d3.geo.equirectangular()
                .scale((width) / 2.5 / Math.PI)
                .translate([width / 1.8, 240])
                .precision(.1);

        var path = d3.geo.path()
                .projection(projection);

        var svg = d3.select("#heroPhotos").append("svg")
                .attr("id", "heroList")
                .attr("width", 1000)
                .attr("height", 450);

        var map = d3.select("#map").append("svg")
                .attr("id","map")
                .attr("width",1280)
                .attr("height",500);

        var bioArea = d3.select("#heroBioPic").append("svg")
                .attr("id","charList")
                .attr("width",350)
                .attr("height",300);

        var defs = map.append("defs");

        var activeFilters = [];
        var coordX = 15;
        var coordY = 15;
        var counter = 0;
        var sortFilter = document.getElementById("sortFilter");

       

        //Populate the characters based on initial category choice
        populateCharacters(data);

        //Found this sort on a stackoverflow question: http://stackoverflow.com/questions/8175093/simple-function-to-sort-an-array-of-objects/8175221#8175221
        function sortByKey(array, key) {
            return array.sort(function (a, b) {
                var x = a[key];
                var y = b[key];
                return ((x < y) ? -1 : ((x > y) ? 1 : 0));
            });

        };


        d3.select("#sortFilter").on("change", function () {
            sortFilter = document.getElementById("sortFilter").value;
            if (sortFilter == "random") {
                updatePositions(shuffleArray(data))
            }
            else {
                var updateChar = sortByKey(data, sortFilter);
                updatePositions(updateChar);

            }
        });

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        };

        //Creating images of characters both in first list and in the map area bio
        for (var i = 0; i < charList.length; i++) {
            character = charList[i];

            characters[character.shortName] = {
                "shortName": character.shortName,
                "Coordinates": character.Coordinates,
                "originYear": character.originYear,
                "Birthplace": character.Birthplace,
                "img": character.img
            };

            if (character.originYear in charaByYears) {
                charaByYears[character.originYear].push(character.shortName);
            }
            else {
                charaByYears[character.originYear] = [character.shortName];
            }

            var hero = d3.select("#heroList").append("g").attr("id", charList[i].shortName).classed("dim", true);
            var charBio = d3.select("#charList").append("g").attr("id", charList[i].shortName + "_bio").classed("hidden", true);

        }

        function populateCharacters(charList) {

            //Creating images of characters both in first list and in the map area bio
            for (var i = 0; i < charList.length; i++) {
                var hero = d3.select("#heroList").append("g").attr("id", charList[i].shortName).classed("dim", true);

                //Character history photos for the history section
                hero.append("circle")
                        .attr("class", charList[i].identity)
                        .attr("id", charList[i].shortName + "_circle")
                        .attr("cx", coordX + 30)
                        .attr("cy", coordY + 30)
                        .attr("r", 30)
                        .style("fill", "none")
                        .style("stroke-width", "3")
                        .attr("display", "none");

                hero.append("svg:image")
                        .attr("xlink:href", "img/" + charList[i].img)
                        .attr("width", 60)
                        .attr("height", 60)
                        .attr("x", coordX)
                        .attr("y", coordY)
                        .on("mouseover", function (d) {
                            d3.select(this).transition()
                                    .attr("width", 70)
                                    .attr("height",70)
                                    .attr("transform", "translate(" + -5 + "," + -5 + ")")
                            d3.select(this.previousSibling)
                                    .attr("display","inherit")
                                    .transition().attr("r",35);

                        })
                        .on("mouseout", function () {
                            d3.select(this).transition().attr("width", 60).attr("height", 60)
                                    .attr("transform", "translate(" + 0  +"," + 0 + ")");
                            d3.select(this.previousSibling)
                                    .transition().attr("r",30).duration(1000).attr("display", "none");

                        });
                $("#" + charList[i].shortName).popover({
                    content: charList[i].Name + " first appeared in " + charList[i].firstIssue,
                    container:"body",
                    html: true,
                    trigger: "hover"
                });

                //Shift photos in the character history so they don't overlap
                coordX = coordX + 70;
                counter = counter + 1;
                if (counter == 13) {
                    counter = 0;
                    coordX = 15;
                    coordY = coordY + 70;
                }
            }
        }

        function updatePositions(charList) {
            var counter = 0;
            var xCoord = 15;
            var yCoord = 15;

            for (var i = 0; i < charList.length; i++) {
                var tempChar = d3.select("#" + charList[i].shortName).select("image").transition().duration(1000).attr("x", xCoord).attr("y", yCoord);

                d3.select("#" + charList[i].shortName).select("circle")
                        .transition()
                        .attr("cx", xCoord + 30)
                        .attr("cy", yCoord +30);

                xCoord = xCoord + 70;
                counter = counter + 1;

                if (counter == 13) {
                    counter = 0;
                    xCoord = 15;
                    yCoord = yCoord + 70;
                }
            }
            ;
        };


        var bubbleSlide = document.getElementById("slider");
        //Character bubble slider
        bubbleSlide.oninput = function () {

            var curYear = this.value;
            document.getElementById("year").innerHTML = curYear;
            showResults();
            d3.json("json/marvelHistory.json", function (error, d) {
                var history = d;
                if (error) {
                    console.log(error);
                }

                for (var i = 0; i < history.length; i++) {
                    if (curYear == history[i].Date) {
                        document.getElementById("fact").innerHTML = history[i].event + " (" + history[i].Date + ")";
                    }
                }

            });

        };

        var mapSlide = document.getElementById("sliderMap");
        var updateMap = function(curYear){
            d3.selectAll("circle.event").remove();
            
            if(curYear in events) {
                
                e = events[mapSlide.value];
                e.places.forEach(function(place_coord){
                var coord = projection([place_coord[1], place_coord[0]]);
                
                map.append("circle")
                    .attr("class", "event")
                    .attr("cx", coord[0])
                    .attr("cy", coord[1])
                    .attr("r", 5)
                    .style("fill", "#f03138")
                    .style('opacity', .5);
                });
                
            }

            d3.selectAll("circle.birthplace").remove();
            if(curYear in charaByYears) {
                charaByYears[curYear].forEach(function(char_id){
                    var char = characters[char_id];
                    var coord = projection([char.Coordinates[1], char.Coordinates[0]]);
                    def = d3.select("#map defs #"+char_id+"-img");
                    if (def.length > 0) {
                        imgname =
                        defs.append("pattern")
                        .attr('id', char_id+"-img")
                        .attr("height", "40")
                        .attr("width", "40")
                        .append("image")
                        .attr('id', char_id+"-image")
                        .attr('class', 'chara-img')
                        .attr('xlink:href', 'img/'+char.img)
                        .attr("height", "40")
                        .attr("width", "40")
                        .attr("x","0")
                        .attr("y","0");
                    }

                    var point = map.append("circle")
                            .attr("id", char_id+"-birthplace")
                            .attr("cx", coord[0])
                            .attr("cy", coord[1])
                            .attr("r", 20)
                            .attr("stroke", "white")
                            .attr("stroke-width", 1)
                            .attr("class", "birthplace")
                            .style("fill", 'url(#'+char_id+'-img)').on('mouseenter', function() {
                                this.parentElement.appendChild(this);
                              });
                    console.log(char_id);
                    $("#"+char_id+"-birthplace").popover({
                        content: '<table>'
                            +'<tr><td>Name </td><td>'+characterInfo[char_id].name+'</td></tr>'
                            +'<tr><td>Gender </td><td>'+characterInfo[char_id].gender+'</td></tr>'
                            +'<tr><td>Height </td><td>'+characterInfo[char_id].height+'</td></tr>'
                            +'<tr><td>Weight </td><td>'+characterInfo[char_id].weight+'</td></tr>'
                            +'<tr><td>Eyes </td><td>'+characterInfo[char_id].eyes+'</td></tr>'
                            +'<tr><td>Hair </td><td>'+characterInfo[char_id].hair+'</td></tr>'
                            +'<tr><td>Birth Place </td><td class="categoryInfo">'+characters[char_id]['Birthplace']+'</td></tr>'
                            +'</table>',
                        container:"body",
                        html: true,
                        trigger: "hover"
                    });

                });
            }
        };
        mapSlide.oninput = function(){
            updateMap(mapSlide.value);
        };


        //Creates a filter for the character list based on checkboxes
        d3.selectAll(".filter").on("change", function () {
            var type = this.value;

            if (!this.checked) {
                activeFilters.push(type);
            }

            if (this.checked) {
                var i = activeFilters.indexOf(this.value);
                if (i != -1) {
                    activeFilters.splice(i, 1);
                }
            }
            showResults();

        });

        //Checking to make sure of the year that is inputed against the origin year of the character
        var checkYear = function (character) {

            if (slider.value >= character.originYear) {
                return true;
            }
            else {
                return false;
            }
        };

        var filterResults = function(character){

            if ( !checkYear(character) && activeFilters.length == 0)
            {
                return "false";
            }
            for (var i = 0; i < Object.keys(character).length; i++) {
                for (var j = 0; j < activeFilters.length; j++) {
                    if (
                            !checkYear(character) || character.Gender == activeFilters[j] || character.identity == activeFilters[j]
                    ) {
                        return "true";
                    }
                }
            }
        };


        var showResults = function () {

            for (var i = 0; i < data.length; i++) {
                if ((filterResults(data[i]))) {
                    d3.select("#" + data[i].shortName)
                            .classed("dim", true);
                }
                else {
                    d3.select("#" + data[i].shortName)
                            .classed("dim", false);
                }
            }
        };

        d3.json("json/characters_info.json", function (error,
            charInfo){
            if (error) throw error;
            charInfo.forEach(function(info){
                characterInfo[info.shortname] = info;
            });

            //Starting Map Section
            d3.json("world-50m.json", function (error, world) {
                if (error) throw error;

                map.insert("path", ".graticule")
                        .datum(topojson.feature(world, world.objects.land))
                        .attr("d", path)
                        .style("fill", "white");

                map.insert("path", ".graticule")
                        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
                        .attr("class", "boundary")
                        .attr("d", path)
                        .style("stroke", "#ccc");
            });
        });

        var sliderwidth = d3.select("#sliderMap").node().getBoundingClientRect().width;
        var time_scale = d3.scale.linear().domain([1938, 2016]).range([ 0, sliderwidth]);

        events = {  
                "1939": {"places": [[41.57, 12.30],[9.145000, 40.489673],[51.165691, 10.451526]], "eventname": "WORLD WAR II", "img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"},
                "1940": {"places": [[35.861660, 104.195397],[36.204824, 138.252924],[47.516231, 14.550072],[51.165691, 10.451526],[41.871940, 12.56738],[44.980733, 20.169453],[56.263920, 9.501785],[60.472024, 8.468946] ], "eventname": "WORLD WAR II","img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"},
                "1941": {"places": [[23.416203, 25.66283],[42.733883, 25.48583],[47.162494, 19.503304],[51.220643, 51.363519],[55.755826, 37.6173],[21.344507, -157.974891],[12.879721, 121.774017],[14.058324, 108.277199],[1.352083, 103.819836]], "eventname": "WORLD WAR II","img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"}, 
                "1942": {"places": [[45.813398, 15.964656],[28.207217, -177.373493],[48.708048, 44.513303],[-9.645710, 160.156194],[28.033886, 1.659626],[33.886917, 9.537499],[31.869706, 115.747628],[45.943161, 24.96676]], "eventname": "WORLD WAR II"},
                "1943": {"places": [[33.886917, 9.537499],[37.599994, 14.015356],[51.709196, 36.156224],[42.017239, 14.859782],[26.142036, -81.79481]], "eventname": "WORLD WAR II","img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"},
                "1944": {"places": [[41.449596, 12.619725],[37.981835, -80.423567],[48.879870, 0.171253],[53.709807, 27.953389],[48.856614, 2.352222],[43.710173, 7.261953],[12.879721, 121.774017],[50.503887, 4.469936]], "eventname": "WORLD WAR II","img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"},
                "1945": {"places": [[50.573280, 7.238553],[52.520007, 13.404954],[45.815011, 15.981919],[47.516231, 14.550072],[41.871940, 12.56738],[26.212401, 127.680932],[34.385203, 132.455293],[19.445411, -99.089734]], "eventname": "WORLD WAR II","img_src":"http://vignette3.wikia.nocookie.net/marveldatabase/images/9/9d/World_War_II_001.jpg/revision/latest/scale-to-width-down/200?cb=20090825012758"},
                "1960": {"places":[[31.596640, 31.107178], [37.090240, -95.712891]], "eventname": "The Space Race", "img_src":"http://x.annihil.us/u/prod/marvel/i/mg/6/20/519b7424af23c/portrait_incredible.jpg"},
                "1971": {"places": [[37.090240, -95.712891]], "eventname":"Drug Abuse","img_src": "http://i.annihil.us/u/prod/marvel/i/mg/e/40/4bc33acb2b5e0/portrait_incredible.jpg"},
                "2001": {"places":[[40.783060, -73.971249],[38.881621, -77.090981]], "eventname":"9/11", "img_src":"http://cdn.bleedingcool.net/wp-content/uploads/2013/06/image80.jpg?f6a06b"}
            };

        var eventssvg = d3.select("#eventtimeline").append("svg")
                        .attr("width", sliderwidth)
                        .attr("height", 50);
        var eventname = "";
        var cont = false;
        for (year in events) {
            if (eventname == events[year].eventname) { cont = true;}
            else { 
                eventname = events[year].eventname;
                cont = false;
            }
            eventssvg.append("rect")
            .attr("width",20)
            .attr("height", 10)
            .attr("x", time_scale(year)-10 )
            .style("fill", "#f03138")
            .attr("rx", 3)
            .attr("ry", 3);

            if(!cont) {
                eventssvg
                    .append("text").text(eventname)
                    .attr("x", time_scale(year)-10)
                    .attr("y", 30)
                    .style("fill", "#f03138");
            } 
            // eventssvg.call(d3.slider().axis(true).min(2000).max(2100).step(5));

        }


    });

    </script>

</body>
</html>
